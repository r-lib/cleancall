<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Wrapper of .Call() that runs exit handlers to clean up C
    resources. Helps managing C (non-R) resources while using the R API.">
<title>C Resource Cleanup via Exit Handlers • cleancall</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="deps/Source_Sans_Pro-0.4.4/font.css" rel="stylesheet">
<link href="deps/Source_Code_Pro-0.4.4/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="C Resource Cleanup via Exit Handlers">
<meta property="og:description" content="Wrapper of .Call() that runs exit handlers to clean up C
    resources. Helps managing C (non-R) resources while using the R API.">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="r-lib.github.io/cleancall,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">cleancall</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.1.3.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/cleancall/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="cleancall">cleancall<a class="anchor" aria-label="anchor" href="#cleancall"></a>
</h1></div>
<blockquote>
<p>C Resource Cleanup via Exit Handlers</p>
</blockquote>
<!-- badges: start -->

<div class="section level2">
<h2 id="features">Features<a class="anchor" aria-label="anchor" href="#features"></a>
</h2>
<ul>
<li>Add exit handlers to a <code><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call()</a></code> to C, via a <code><a href="reference/call_with_cleanup.html">call_with_cleanup()</a></code> wrapper.</li>
<li>Restrict an exit handler to run only on early exit (error, interrupt, debugger exit, restart invokation, condition caught, etc.). I.e. anything that prevented your function from running its normal course.</li>
<li>Exit handlers are executed in reverse order. Last added runs first.</li>
<li>Exit handlers can be added from any downstream function, they don’t need to be called directly from the function called by <code><a href="reference/call_with_cleanup.html">call_with_cleanup()</a></code>.</li>
</ul>
</div>
<div class="section level2">
<h2 id="limitations">Limitations<a class="anchor" aria-label="anchor" href="#limitations"></a>
</h2>
<p>We suggest that exit handlers are kept as simple and fast as possible. In particular, errors (and other early exits) triggered from exit handlers are not caught currently. If an exit handler exits early the others do not run. If this is an issue, you can wrap the exit handler in <code>R_tryCatch()</code> (available for R 3.4.0 and later).</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the released version of cleancall from <a href="https://CRAN.R-project.org" class="external-link">CRAN</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"cleancall"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>This example is from the processx package. Its <code>processx_wait()</code> function waits for an external process to end, and this wait is interruptible. <code>processx_wait()</code> opens two temporary file descriptors for the wait, and these need to be closed at the end of the function, even on an interrupt, otherwise we have a resource leak.</p>
<p>See <a href="https://github.com/r-lib/processx/blob/a8f09d147fead78347a87fcf4e0fbd1c07de1c21/src/unix/processx.c#L507-L589" class="external-link">this link</a> for the complete function, before fixing.</p>
<p>Here we only include the relevant parts:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>SEXP processx_wait<span class="op">(</span>SEXP status<span class="op">,</span> SEXP timeout<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  processx_handle_t <span class="op">*</span>handle <span class="op">=</span> R_ExternalPtrAddr<span class="op">(</span>status<span class="op">);</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> ctimeout <span class="op">=</span> INTEGER<span class="op">(</span>timeout<span class="op">)[</span><span class="dv">0</span><span class="op">],</span> timeleft <span class="op">=</span> ctimeout<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> pollfd fd<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> ret <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  pid_t pid<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">[...]</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Setup the self-pipe that we can poll */</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>pipe<span class="op">(</span>handle<span class="op">-&gt;</span>waitpipe<span class="op">))</span> <span class="op">{</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    processx__unblock_sigchld<span class="op">();</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    error<span class="op">(</span><span class="st">"processx error: %s"</span><span class="op">,</span> strerror<span class="op">(</span>errno<span class="op">));</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">[...]</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>ctimeout <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> timeleft <span class="op">&gt;</span> PROCESSX_INTERRUPT_INTERVAL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>      ret <span class="op">=</span> poll<span class="op">(&amp;</span>fd<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> PROCESSX_INTERRUPT_INTERVAL<span class="op">);</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>ret <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="op">&amp;&amp;</span> errno <span class="op">==</span> EINTR<span class="op">);</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* If not a timeout, then we are done */</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    R_CheckUserInterrupt<span class="op">();</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">[...]</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">[...]</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>cleanup<span class="op">:</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>handle<span class="op">-&gt;</span>waitpipe<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span> close<span class="op">(</span>handle<span class="op">-&gt;</span>waitpipe<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>handle<span class="op">-&gt;</span>waitpipe<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span> close<span class="op">(</span>handle<span class="op">-&gt;</span>waitpipe<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  handle<span class="op">-&gt;</span>waitpipe<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  handle<span class="op">-&gt;</span>waitpipe<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ScalarLogical<span class="op">(</span>ret <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/r/base/connections.html" class="external-link">pipe()</a></code> allocates two file descriptors, they are saved in <code>handle-&gt;waitpipe[0]</code> and <code>handle-&gt;waitpipe[1]</code>. The wait is interruptible, so the function calls <code>R_CheckUserInterrupt()</code>. This checks for a <code>CTRL+C</code> or <code>ESC</code> interrupt, and if there was one, it returns directly to the caller of <code><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call()</a></code>. This is of course problematic, because <code>processx_wait()</code> has no chance of closing the pipe file descriptors.</p>
<p>Fixing this with cleancall is as follows. First your package needs to depend on cleancall, update <code>DESCRIPTION</code>:</p>
<pre><code>[...]
Imports:
    cleancall,
LinkingTo:
    cleancall
[...]</code></pre>
<p>In the R code calling <code>processx_wait(),</code> replace <code><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call()</a></code> with <code><a href="reference/call_with_cleanup.html">cleancall::call_with_cleanup()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cleancall</span><span class="fu">::</span><span class="fu"><a href="reference/call_with_cleanup.html">call_with_cleanup</a></span><span class="op">(</span><span class="va">c_processx_wait</span>, <span class="va">private</span><span class="op">$</span><span class="va">status</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">timeout</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then include the <code>cleancall.h</code> header in the C code, and use <code>r_call_on_exit()</code> to push a cleanup handler to the stack of the foreign call:</p>
<pre><code>#include &lt;cleancall.h&gt;

[...]

static void processx__close_fd(void *ptr) {
  int *fd = ptr;
  if (*fd &gt;= 0) close(*fd);
}

SEXP processx_wait(SEXP status, SEXP timeout) {
  processx_handle_t *handle = R_ExternalPtrAddr(status);

  [...]

  if (pipe(handle-&gt;waitpipe)) {
    processx__unblock_sigchld();
    error("processx error: %s", strerror(errno));
  }
  r_call_on_exit(processx__close_fd, handle-&gt;waitpipe);
  r_call_on_exit(processx__close_fd, handle-&gt;waitpipe + 1);

  [...]
}</code></pre>
<p>You can see the <a href="https://github.com/r-lib/processx/commit/d05aadd4b0975a391d35a05958421f242bf96d23" class="external-link">whole fix as a commit message on GitHub</a>.</p>
<p>See also our blog post at <a href="https://www.tidyverse.org/articles/2019/05/resource-cleanup-in-c-and-the-r-api/" class="external-link uri">https://www.tidyverse.org/articles/2019/05/resource-cleanup-in-c-and-the-r-api/</a></p>
<p>Note that the cleanup functions cannot generally assume that stack-allocated data are still around at the time they are called. This is usually not a problem since cleanup is mostly about objects allocated on the heap with non-automatic storage. If needed, you can protect stack-allocated data from being unwound by using <code>r_with_cleanup_context()</code>. This becomes the point at which cleanup functions are called, which ensures any object allocated on the stack before that point are still around.</p>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<div class="section level3">
<h3 id="void-r_call_on_exitvoid-fnvoid-data-void-data">
<code>void r_call_on_exit(void (*fn)(void* data), void *data)</code><a class="anchor" aria-label="anchor" href="#void-r_call_on_exitvoid-fnvoid-data-void-data"></a>
</h3>
<p>Push an exit handler to the stack. This exit handler is always executed, i.e. both on normal and early exits.</p>
<p>Exit handlers are executed right after the function called from <code><a href="reference/call_with_cleanup.html">call_with_cleanup()</a></code> exits. (Or the function used in <code>r_with_cleanup_context()</code>, if the cleanup context was established from C.)</p>
<p>Exit handlers are executed in reverse order (last in is first out, LIFO). Exit handlers pushed with <code>r_call_on_exit()</code> and <code>r_call_on_early_exit()</code> share the same stack.</p>
<p>Best practice is to use this function immediately after acquiring a resource, with the appropriate cleanup function for that resource.</p>
</div>
<div class="section level3">
<h3 id="void-r_call_on_early_exitvoid-fnvoid-data-void-data">
<code>void r_call_on_early_exit(void (*fn)(void* data), void *data)</code><a class="anchor" aria-label="anchor" href="#void-r_call_on_early_exitvoid-fnvoid-data-void-data"></a>
</h3>
<p>Push an exit handler to the stack. This exit handler is only executed on early exists, <em>not</em> on normal termination.</p>
<p>Exit handlers are executed right after the function called from <code><a href="reference/call_with_cleanup.html">call_with_cleanup()</a></code> exits. (Or the function used in <code>r_with_cleanup_context()</code>, if the cleanup context was established from C.)</p>
<p>Exit handlers are executed in reverse order (last in is first out, LIFO). Exit handlers pushed with <code>r_call_on_exit()</code> and <code>r_call_on_early_exit()</code> share the same stack.</p>
<p>Best practice is to use this function immediately after acquiring a resource, with the appropriate cleanup function for that resource.</p>
</div>
<div class="section level3">
<h3 id="sexp-r_with_cleanup_contextsexp-fnvoid-data-void-data">
<code>SEXP r_with_cleanup_context(SEXP (*fn)(void* data), void* data)</code><a class="anchor" aria-label="anchor" href="#sexp-r_with_cleanup_contextsexp-fnvoid-data-void-data"></a>
</h3>
<p>Establish a cleanup stack and call <code>fn</code> with <code>data</code>. This function can be used to establish a cleanup stack from C code.</p>
</div>
</div>
<div class="section level2">
<h2 id="embedding-cleancall">Embedding cleancall<a class="anchor" aria-label="anchor" href="#embedding-cleancall"></a>
</h2>
<p>If you don’t want to depend on the cleancall package, you can also easily embed the cleancall code into your package. These are the steps that you need to do:</p>
<ol style="list-style-type: decimal">
<li><p>Copy the <code>cleancall.R</code> file into your package, into the <code>R/</code> directory.</p></li>
<li><p>Copy the <code>cleancall.h</code> and <code>cleancall.c</code> files into your package, into <code>src/</code>.</p></li>
<li><p>If you have a <code>Makevars</code> and/or <code>Makevars.win</code> file, and you define <code>OBJECTS</code> there, add <code>cleancall.o</code> to <code>OBJECTS</code>.</p></li>
<li>
<p>Use the <code>CLEANCALL_METHOD_RECORD</code> macro in your registration of C functions. E.g.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"cleancall.h"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">[...]</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> R_CallMethodDef callMethods<span class="op">[]</span>  <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  CLEANCALL_METHOD_RECORD<span class="op">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">[...]</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span> NULL<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span> <span class="op">}</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
</li>
<li>
<p>Add this call to your package init function:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cleancall_init<span class="op">();</span></span></code></pre></div>
</li>
<li><p>Use <code><a href="reference/call_with_cleanup.html">call_with_cleanup()</a></code> instead of <code><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call()</a></code> for the C functions that you want to add cleanup code to.</p></li>
<li><p>Add the <code>r_call_on_exit()</code> etc. calls to your C function(s).</p></li>
</ol>
<p>This is an example pull request that embeds cleancall into processx: <a href="https://github.com/r-lib/processx/pull/238" class="external-link uri">https://github.com/r-lib/processx/pull/238</a> (This pull request is slightly more complicated than a minimal example, because it uses a wrapper to <code>.Call</code> already.)</p>
</div>
<div class="section level2">
<h2 id="code-of-conduct">Code of Conduct<a class="anchor" aria-label="anchor" href="#code-of-conduct"></a>
</h2>
<p>Please note that the cleancall project is released with a <a href="https://r-lib.github.io/cleancall/CODE_OF_CONDUCT.html">Contributor Code of Conduct</a>. By contributing to this project, you agree to abide by its terms.</p>
</div>
<div class="section level2">
<h2 id="license">License<a class="anchor" aria-label="anchor" href="#license"></a>
</h2>
<p>MIT @ <a href="https://github.com/rstudio" class="external-link">RStudio</a></p>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=cleancall" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/r-lib/cleancall/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/r-lib/cleancall/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CONTRIBUTING.html">Contributing guide</a></li>
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing cleancall</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>
<a href="https://github.com/lionel-" class="external-link">Lionel Henry</a> <br><small class="roles"> Author </small>  </li>
<li>
<a href="https://github.com/gaborcsardi" class="external-link">Gábor Csárdi</a> <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-7098-9676" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>
<a href="https://www.rstudio.com" class="external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" width="72"></a> <br><small class="roles"> Copyright holder, funder </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/r-lib/cleancall/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/r-lib/cleancall/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://cran.r-project.org/package=cleancall" class="external-link"><img src="https://www.r-pkg.org/badges/version/cleancall"></a></li>
<li><a href="https://www.r-pkg.org/pkg/cleancall" class="external-link"><img src="https://cranlogs.r-pkg.org/badges/cleancall" alt="CRAN RStudio mirror downloads"></a></li>
<li><a href="https://app.codecov.io/gh/r-lib/cleancall?branch=main" class="external-link"><img src="https://codecov.io/gh/r-lib/cleancall/branch/main/graph/badge.svg" alt="Codecov test coverage"></a></li>
</ul>
</div>

  </aside>
</div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://github.com/gaborcsardi" class="external-link">Gábor Csárdi</a>, <a href="https://www.rstudio.com" class="external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

  </div></footer>
</body>
</html>
